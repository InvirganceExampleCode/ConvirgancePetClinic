<?xml version="1.0" encoding="UTF-8"?>

<RoutedService>
    <routes>
        <map>
            <entry>
                <string>/services/owner</string>
                <RESTService>
                    <GET>
                        <SelectService>
                            <parameters>
                                <list>
                                    <PathVariable>
                                        <path>/services/owner/{id}</path>
                                    </PathVariable>
                                </list>
                            </parameters>
                            <binding>
                                <QueryBinding>
                                    <jndiName>jdbc/petclinic</jndiName>
                                    <sql>
                                        <![CDATA[
                                            select
                                                o.id as "id",
                                                o.first_name as "firstName",
                                                o.last_name as "lastName",
                                                o.address as "address",
                                                o.city as "city",
                                                o.telephone as "telephone",
                                                p.id  as "petId",
                                                p.name as "name",
                                                p.birth_date as "birthDate"
                                            from owners o
                                            left join pets p on p.owner_id = o.id
                                            where o.id = :id
                                        ]]>
                                    </sql>
                                </QueryBinding>
                            </binding>
                            <transformers>
                                <list>
                                    <object class="com.invirgance.convirgance.transform.SortedGroupByTransformer">
                                        <fields>id, firstName, lastName, address, city, telephone</fields>
                                        <output>pets</output>
                                    </object>
                                </list>
                            </transformers>
                            <output>
                                <JSONOutput />
                            </output>
                        </SelectService>
                    </GET>
                    <POST>
                        <InsertService>
                            <origin>
                                <RequestBodyOrigin />
                            </origin>
                            <input>
                                <JSONInput />
                            </input>
                            <transformers>
                                <list>
                                    <NotBlankValidation>
                                        <key>firstName</key>
                                    </NotBlankValidation>
                                    <NotBlankValidation>
                                        <key>lastName</key>
                                    </NotBlankValidation>
                                    <NotBlankValidation>
                                        <key>address</key>
                                    </NotBlankValidation>
                                    <NotBlankValidation>
                                        <key>city</key>
                                    </NotBlankValidation>
                                    <NotBlankValidation>
                                        <key>telephone</key>
                                    </NotBlankValidation>
                                    <RegExValidation>
                                        <key>telephone</key>
                                        <regex>\d{10}</regex>
                                    </RegExValidation>
                                </list>
                            </transformers>
                            <consumer>
                                <QueryConsumer>
                                    <jndiName>jdbc/petclinic</jndiName>
                                    <sql>
                                        <![CDATA[
                                            insert into owners (
                                                id,
                                                first_name,
                                                last_name,
                                                address,
                                                city,
                                                telephone
                                            ) values (
                                                :id,
                                                :firstName,
                                                :lastName,
                                                :address,
                                                :city,
                                                :telephone
                                            )
                                        ]]>
                                    </sql>
                                    <sequenceSql>
                                        <![CDATA[
                                            VALUES NEXT VALUE FOR identifiers
                                        ]]>
                                    </sequenceSql>
                                    <sequenceId>id</sequenceId>
                                </QueryConsumer>
                            </consumer>
                        </InsertService>
                    </POST>
                    <PUT>
                        <InsertService>
                            <parameters>
                                <list>
                                    <PathVariable>
                                        <path>/services/owner/{id}</path>
                                    </PathVariable>
                                </list>
                            </parameters>
                            <origin>
                                <RequestBodyOrigin />
                            </origin>
                            <input>
                                <JSONInput />
                            </input>
                            <injectParameters>
                                <list>
                                    <string>id</string>
                                </list>
                            </injectParameters>
                            <transformers>
                                <list>
                                    <NotNullValidation>
                                        <key>id</key>
                                    </NotNullValidation>
                                    <NotBlankValidation>
                                        <key>firstName</key>
                                    </NotBlankValidation>
                                    <NotBlankValidation>
                                        <key>lastName</key>
                                    </NotBlankValidation>
                                    <NotBlankValidation>
                                        <key>address</key>
                                    </NotBlankValidation>
                                    <NotBlankValidation>
                                        <key>city</key>
                                    </NotBlankValidation>
                                    <NotBlankValidation>
                                        <key>telephone</key>
                                    </NotBlankValidation>
                                    <RegExValidation>
                                        <key>telephone</key>
                                        <regex>\d{10}</regex>
                                    </RegExValidation>
                                </list>
                            </transformers>
                            <consumer>
                                <QueryConsumer>
                                    <jndiName>jdbc/petclinic</jndiName>
                                    <sql>
                                        <![CDATA[
                                            update owners 
                                            set
                                                first_name = :firstName,
                                                last_name = :lastName,
                                                address = :address,
                                                city = :city,
                                                telephone = :telephone
                                            where id = :id
                                        ]]>
                                    </sql>
                                </QueryConsumer>
                            </consumer>
                        </InsertService>
                    </PUT>
                </RESTService>
            </entry>
            <entry>
                <string>/services/owner/*/pets</string>
                <SelectService>
                    <parameters>
                        <list>
                            <PathVariable>
                                <path>/services/owner/{ownerId}/pets</path>
                            </PathVariable>
                        </list>
                    </parameters>
                    <binding>
                        <QueryBinding>
                            <jndiName>jdbc/petclinic</jndiName>
                            <sql>
                                <![CDATA[
                                    select
                                        p.id as "id",
                                        p.name as "name",
                                        p.birth_date as "birthDate",
                                        p.owner_id as "ownerId",
                                        o.first_name || ' ' ||  o.last_name as "ownerName",
                                        t.id as "typeId",
                                        t.name as "type",
                                        v.visit_date as "visitDate",
                                        v.description as "description"
                                    from pets p
                                    join types t on t.id = p.type_id
                                    join owners o on o.id = p.owner_id
                                    left join visits v on v.pet_id = p.id
                                    where p.owner_id = :ownerId
                                    order by p.name, p.birth_date, v.visit_date
                                ]]>
                            </sql>
                        </QueryBinding>
                    </binding>
                    <transformers>
                        <list>
                            <object class="com.invirgance.convirgance.transform.SortedGroupByTransformer">
                                <fields>id, name, birthDate, ownerId, ownerName, typeId, type</fields>
                                <output>visits</output>
                            </object>
                        </list>
                    </transformers>
                    <output>
                        <JSONOutput />
                    </output>
                </SelectService>
            </entry>
            <entry>
                <string>/services/owner/*/pet</string>
                <RESTService>
                    <GET>
                        <SelectService>
                            <parameters>
                                <list>
                                    <PathVariable>
                                        <path>/services/owner/{ownerId}/pet/*</path>
                                    </PathVariable>
                                    <PathVariable>
                                        <path>/services/owner/*/pet/{id}</path>
                                    </PathVariable>
                                </list>
                            </parameters>
                            <binding>
                                <QueryBinding>
                                    <jndiName>jdbc/petclinic</jndiName>
                                    <sql>
                                        <![CDATA[
                                            select
                                                p.id as "id",
                                                p.name as "name",
                                                p.birth_date as "birthDate",
                                                p.owner_id as "ownerId",
                                                o.first_name || ' ' ||  o.last_name as "ownerName",
                                                t.id as "typeId",
                                                t.name as "type",
                                                v.visit_date as "visitDate",
                                                v.description as "description"
                                            from pets p
                                            join types t on t.id = p.type_id
                                            join owners o on o.id = p.owner_id
                                            left join visits v on v.pet_id = p.id
                                            where p.owner_id = :ownerId
                                            and p.id = :id
                                            order by p.name, p.birth_date, v.visit_date
                                        ]]>
                                    </sql>
                                </QueryBinding>
                            </binding>
                            <transformers>
                                <list>
                                    <object class="com.invirgance.convirgance.transform.SortedGroupByTransformer">
                                        <fields>id, name, birthDate, ownerId, ownerName, typeId, type</fields>
                                        <output>visits</output>
                                    </object>
                                </list>
                            </transformers>
                            <output>
                                <JSONOutput />
                            </output>
                        </SelectService>
                    </GET>
                    <POST>
                        <InsertService>
                            <parameters>
                                <list>
                                    <PathVariable>
                                        <path>/services/owner/{ownerId}/pet</path>
                                    </PathVariable>
                                </list>
                            </parameters>
                            <origin>
                                <RequestBodyOrigin />
                            </origin>
                            <input>
                                <JSONInput />
                            </input>
                            <injectParameters>
                                <list>
                                    <string>ownerId</string>
                                </list>
                            </injectParameters>
                            <transformers>
                                <list>
                                    <NotBlankValidation>
                                        <key>name</key>
                                    </NotBlankValidation>
                                    <NotBlankValidation>
                                        <key>birthDate</key>
                                    </NotBlankValidation>
                                    <NotBlankValidation>
                                        <key>type</key>
                                    </NotBlankValidation>
                                    <NotNullValidation>
                                        <key>ownerId</key>
                                    </NotNullValidation>
                                </list>
                            </transformers>
                            <consumer>
                                    <QueryConsumer>
                                    <jndiName>jdbc/petclinic</jndiName>
                                    <sql>
                                        <![CDATA[
                                            insert into pets (
                                                id,
                                                name,
                                                birth_date,
                                                type_id,
                                                owner_id
                                            ) values (
                                                :id,
                                                :name,
                                                :birthDate,
                                                (select id from types where name = :type),
                                                :ownerId
                                            )
                                        ]]>
                                    </sql>
                                    <sequenceSql>
                                        <![CDATA[
                                            VALUES NEXT VALUE FOR identifiers
                                        ]]>
                                    </sequenceSql>
                                    <sequenceId>id</sequenceId>
                                </QueryConsumer>
                            </consumer>
                        </InsertService>
                    </POST>
                    <PUT>
                        <InsertService>
                            <parameters>
                                <list>
                                    <PathVariable>
                                        <path>/services/owner/{ownerId}/pet/*</path>
                                    </PathVariable>
                                    <PathVariable>
                                        <path>/services/owner/*/pet/{id}</path>
                                    </PathVariable>
                                </list>
                            </parameters>
                            <origin>
                                <RequestBodyOrigin />
                            </origin>
                            <input>
                                <JSONInput />
                            </input>
                            <injectParameters>
                                <list>
                                    <string>id</string>
                                    <string>ownerId</string>
                                </list>
                            </injectParameters>
                            <transformers>
                                <list>
                                    <NotNullValidation>
                                        <key>id</key>
                                    </NotNullValidation>
                                    <NotNullValidation>
                                        <key>ownerId</key>
                                    </NotNullValidation>
                                    <NotBlankValidation>
                                        <key>name</key>
                                    </NotBlankValidation>
                                    <NotBlankValidation>
                                        <key>birthDate</key>
                                    </NotBlankValidation>
                                    <NotBlankValidation>
                                        <key>type</key>
                                    </NotBlankValidation>
                                </list>
                            </transformers>
                            <consumer>
                                <QueryConsumer>
                                    <jndiName>jdbc/petclinic</jndiName>
                                    <sql>
                                        <![CDATA[
                                            update pets 
                                            set
                                                name = :name,
                                                birth_date = :birthDate,
                                                type_id = (select id from types where name = :type)
                                            where id = :id
                                            and owner_id = :ownerId
                                        ]]>
                                    </sql>
                                </QueryConsumer>
                            </consumer>
                        </InsertService>
                    </PUT>
                </RESTService>
            </entry>
            <entry>
                <string>/services/owner/*/pet/*/visit</string>
                <RESTService>
                    <POST>
                        <InsertService>
                            <parameters>
                                <list>
                                    <PathVariable>
                                        <path>/services/owner/{ownerId}/pet/*/visit</path>
                                    </PathVariable>
                                    <PathVariable>
                                        <path>/services/owner/*/pet/{petId}/visit</path>
                                    </PathVariable>
                                </list>
                            </parameters>
                            <origin>
                                <RequestBodyOrigin />
                            </origin>
                            <input>
                                <JSONInput />
                            </input>
                            <injectParameters>
                                <list>
                                    <string>petId</string>
                                </list>
                            </injectParameters>
                            <transformers>
                                <list>
                                    <NotNullValidation>
                                        <key>petId</key>
                                    </NotNullValidation>
                                    <NotBlankValidation>
                                        <key>visitDate</key>
                                    </NotBlankValidation>
                                    <NotBlankValidation>
                                        <key>description</key>
                                    </NotBlankValidation>
                                </list>
                            </transformers>
                            <consumer>
                                <QueryConsumer>
                                    <jndiName>jdbc/petclinic</jndiName>
                                    <sql>
                                        <![CDATA[
                                            insert into visits (
                                                id,
                                                pet_id,
                                                visit_date,
                                                description
                                            ) values (
                                                :id,
                                                :petId,
                                                :visitDate,
                                                :description
                                            )
                                        ]]>
                                    </sql>
                                    <sequenceSql>
                                        <![CDATA[
                                            VALUES NEXT VALUE FOR identifiers
                                        ]]>
                                    </sequenceSql>
                                    <sequenceId>id</sequenceId>
                                </QueryConsumer>
                            </consumer>
                        </InsertService>
                    </POST>
                </RESTService>
            </entry>
        </map>
    </routes>
</RoutedService>